import datetime
from typing import Set, Optional

from airflow import DAG
from airflow.operators.python_operator import PythonOperator
from sqlalchemy import create_engine, select, text, column
from sqlalchemy.engine import Engine
from sqlalchemy.sql import Select, TableClause, ClauseElement


def chunks(l, n):
    """Yield successive n-sized chunks from l."""
    for i in range(0, len(l), n):
        yield l[i : i + n]


def format_wide_table_select(
    table_name: str,
    engine: Engine,
    excluded_fields: Optional[Set[str]] = None,
    conditions: Optional[ClauseElement] = None,
):
    excluded_fields = excluded_fields or set()

    with engine.begin() as tx:
        stmt = Select(
            columns=[column("column_name")],
            from_obj=text("information_schema.columns"),
            whereclause=text(f"table_name = '{table_name}'"),
        )

        column_chunks = [
            x
            for x in chunks(
                [
                    column(x[0])
                    for x in tx.execute(stmt)
                    if x[0] not in {"id"}.union(excluded_fields)
                ],
                100,
            )
        ]

        tables = [
            select(
                [column("id")] + cols_,
                from_obj=TableClause(table_name, *([column("id")] + cols_)),
                whereclause=conditions,
            )
            for cols_ in column_chunks
        ]

        for i, table in enumerate(tables):
            table.schema = "salesforce"
            tables[i] = table.alias(f"t{i}")

        stmt = tables[0]

        for i in range(1, len(tables)):
            stmt = stmt.join(tables[i], tables[0].c.id == tables[i].c.id)

        stmt = select(
            [tables[0].c.id]
            + [
                col
                for table_ in tables
                for col in table_.c
                if col.name not in {"id"}.union(excluded_fields)
            ],
            from_obj=stmt,
        )

        return stmt

tables = ['aa_element_for_deployment__c', 'aaa_random__c', 'acceptedeventrelation', 'account_balance__c', 'account_sales_note__c', 'account_score__c', 'account_snapshot__c', 'account_snapshot_daily__c', 'account_snapshot_speed__c', 'account_statistics__c', 'account_status__c', 'account_status_time_entry__c', 'account_summary__c', 'accountbrand', 'accountcontactrole', 'accountml__c', 'accountpartner', 'accountteammember', 'action_item__c', 'actionlinkgrouptemplate', 'actionlinktemplate', 'activescratchorg', 'acton__accountinfo__c', 'added_to_csa_queue__c', 'additional_payments__c', 'additionalnumber', 'adfa_vs_total_portfolio_snapsho__c', 'adminsetupevent', 'advance_size_seasonality_multiple__c', 'agenda_item__c', 'agent_code__c', 'aggregateresult', 'agreementwebapp__c', 'alberta_portfolio_analytic_snapshot__c', 'amazon_s3_settings__c', 'amount_to_writeoff_with_reversals__c', 'amount_withheld_red_flag_bg__c', 'analytic_snapshot_portfolio_by_account__c', 'announcement', 'anticipated_attrition_snapshot__c', 'apexclass', 'apexcomponent', 'apexlog', 'apexpage', 'apexpageinfo', 'apextestqueueitem', 'apextestresult', 'apextestresultlimits', 'apextestrunresult', 'apextestsuite', 'apextrigger', 'apievent', 'apieventstream', 'appdefinition', 'applicant__c', 'applicant_grading__c', 'application__c', 'appmenuitem', 'approval', 'apptabmember', 'apxt_cmqr__conga_merge_query__c', 'apxtconga4__conga_composer_settings__c', 'apxtconga4__conga_email_staging__c', 'apxtconga4__conga_email_template__c', 'apxtconga4__conga_template__c', 'area_code__c', 'asset', 'assetrelationship', 'assettokenevent', 'assigning_flag__c', 'assignmentrule', 'asyncapexjob', 'asynchronous_apex_error__c', 'attachedcontentdocument', 'attachedcontentnote', 'auradefinition', 'auradefinitionbundle', 'auradefinitionbundleinfo', 'auradefinitioninfo', 'authconfig', 'authconfigproviders', 'authsession', 'auto_snapshot__c', 'backgroundoperation', 'backgroundoperationresult', 'bad_debts_factor__c', 'bad_debts_snapshot__c', 'bank_balance_snapshot__c', 'bank_statistics__c', 'base_case_rate__c', 'batch_report_emails__c', 'batch_rule__c', 'batchposting__c', 'beacon_statistics__c', 'blnd_dfcs_carousel__c', 'blnd_dfcs_slide__c', 'blnd_dfff_form__c', 'blnd_dfff_page__c', 'blog_a_en__c', 'bmo_zero_balance__c', 'bmo_zero_balance_load__c', 'bookmark', 'brandingset', 'brandingsetproperty', 'brandtemplate', 'budget__c', 'bug__c', 'business_days__c', 'businesshours', 'businessprocess', 'buyback__c', 'c2g__accountingsummarization2__c', 'c2g__accountingsummarization__c', 'c2g__accountsettings__c', 'c2g__accounttypesettings__c', 'c2g__allocationfilter__c', 'c2g__allocationfilterstructure__c', 'c2g__allocationschedule__c', 'c2g__allocationschedulecompany__c', 'c2g__allocationschedulelog__c', 'c2g__allocationscheduletemplate__c', 'c2g__allocationsplittemplate__c', 'c2g__allocationtemplate__c', 'c2g__allocschedule__c', 'c2g__allocschedulecompany__c', 'c2g__allocschedulelog__c', 'c2g__allocschedulerun__c', 'c2g__allocscheduleruntransaction__c', 'c2g__allocscheduletemplate__c', 'c2g__asofaging__c', 'c2g__asofagingprocesslog__c', 'c2g__asofagingreportsettings__c', 'c2g__asofagingsettings__c', 'c2g__availablesummarizationobject__c', 'c2g__billingsettings__c', 'c2g__budgetsandbalancessettings__c', 'c2g__cancelpayment__c', 'c2g__cancelpaymentlog__c', 'c2g__chartofaccountsmapping__c', 'c2g__chartofaccountsstructure__c', 'c2g__codaaccountingcurrency__c', 'c2g__codaaccountingsettings__c', 'c2g__codaaccountinuse__c', 'c2g__codaagedanalysisdef__c', 'c2g__codabalanceupdateresult__c', 'c2g__codabankaccount__c', 'c2g__codabankreconciliation__c', 'c2g__codabankreconciliationcharge__c', 'c2g__codabankreconciliationlineitem__c', 'c2g__codabankstatement__c', 'c2g__codabankstatementdefinition__c', 'c2g__codabankstatementlineitem__c', 'c2g__codabatchcontrol__c', 'c2g__codabatchcontroldetail__c', 'c2g__codabudget__c', 'c2g__codacashentry__c', 'c2g__codacashentrylineitem__c', 'c2g__codacashmatchinghistory__c', 'c2g__codacashmatchingsettings__c', 'c2g__codachecknumber__c', 'c2g__codacheckrange__c', 'c2g__codacolumnproperty__c', 'c2g__codacompany__c', 'c2g__codacreditnote__c', 'c2g__codacreditnotelineitem__c', 'c2g__codacurrencyrevalbatch__c', 'c2g__codacurrencyrevalbatchlineitem__c', 'c2g__codacurrencyrevaluation__c', 'c2g__codacurrencyrevaluationglaitem__c', 'c2g__codacurrencyrevaluationgroup__c', 'c2g__codacurrencyrevaluationlineitem__c', 'c2g__codacurrencyrevaluationsummary__c', 'c2g__codadataproperty__c', 'c2g__codadimension1__c', 'c2g__codadimension2__c', 'c2g__codadimension3__c', 'c2g__codadimension4__c', 'c2g__codaeventlog__c', 'c2g__codaexchangerate__c', 'c2g__codafinancecorrespondence__c', 'c2g__codaformatdata__c', 'c2g__codageneralledgeraccount__c', 'c2g__codagroupingreference__c', 'c2g__codaincomescheduledefinition__c', 'c2g__codaincschedulestagingjnl__c', 'c2g__codaincschedulestagingjnllineitem__c', 'c2g__codaintegrationrule__c', 'c2g__codaintegrationrulelineitem__c', 'c2g__codaintercompanydefinition__c', 'c2g__codaintercompanytransfer__c', 'c2g__codaintercompanytransferlineitem__c', 'c2g__codaintersectdefinition__c', 'c2g__codainvoice__c', 'c2g__codainvoiceinstallmentlineitem__c', 'c2g__codainvoicelineitem__c', 'c2g__codaitem__c', 'c2g__codajournal__c', 'c2g__codajournallineitem__c', 'c2g__codalookup__c', 'c2g__codamappingformat__c', 'c2g__codamassemailaccount__c', 'c2g__codamassemailaccountlineitem__c', 'c2g__codamatchingreference__c', 'c2g__codaobjectfield__c', 'c2g__codapagenumproperty__c', 'c2g__codapayment__c', 'c2g__codapaymentaccountlineitem__c', 'c2g__codapaymentaccountselection__c', 'c2g__codapaymentbatch__c', 'c2g__codapaymentbatchlineitem__c', 'c2g__codapaymenthistory__c', 'c2g__codapaymentlineitem__c', 'c2g__codapaymentmediacontrol__c', 'c2g__codapaymentmediadetail__c', 'c2g__codapaymentmediasummary__c', 'c2g__codapaymentsettings__c', 'c2g__codapaymenttemplate__c', 'c2g__codapaymenttemplatelineitem__c', 'c2g__codaperiod__c', 'c2g__codaprintformat__c', 'c2g__codaproductinuse__c', 'c2g__codapurchasecreditnote__c', 'c2g__codapurchasecreditnoteexplineitem__c', 'c2g__codapurchasecreditnotelineitem__c', 'c2g__codapurchaseinvoice__c', 'c2g__codapurchaseinvoiceexpenselineitem__c', 'c2g__codapurchaseinvoicelineitem__c', 'c2g__codarecordlock__c', 'c2g__codarecordlockgroup__c', 'c2g__codaschedulelineitem__c', 'c2g__codasection__c', 'c2g__codaselection__c', 'c2g__codaselectioncriterion__c', 'c2g__codasinglemapping__c', 'c2g__codasortorder__c', 'c2g__codatableproperty__c', 'c2g__codataxcode__c', 'c2g__codataxrate__c', 'c2g__codatextdefinition__c', 'c2g__codatransaction__c', 'c2g__codatransactionlineitem__c', 'c2g__codausercompany__c', 'c2g__codavoidpaymentcriteria__c', 'c2g__codayear__c', 'c2g__codayearendlog__c', 'c2g__commonname__c', 'c2g__companyownership__c', 'c2g__currencyrevaluationtemplate__c', 'c2g__currencyrevaluationtemplatelineitem__c', 'c2g__customformassignment__c', 'c2g__customformlayout__c', 'c2g__customformlayoutfield__c', 'c2g__customformlayoutrelatedlist__c', 'c2g__customformlayoutsection__c', 'c2g__dataview__c', 'c2g__dataviewaction__c', 'c2g__dataviewfield__c', 'c2g__dataviewjoin__c', 'c2g__dataviewjoinfilter__c', 'c2g__dataviewtransposeitem__c', 'c2g__fflib_batchprocess__c', 'c2g__fflib_batchprocessdetail__c', 'c2g__fflib_schedulerconfiguration__c', 'c2g__filter__c', 'c2g__filterelement__c', 'c2g__inquirytemplate__c', 'c2g__inquirytemplatecolumn__c', 'c2g__inquirytemplatecolumnfilter__c', 'c2g__inquirytemplatecolumnformula__c', 'c2g__inquirytemplatecommonname__c', 'c2g__inquirytemplateexcludedaction__c', 'c2g__inquirytemplatefilter__c', 'c2g__inquirytemplatercp__c', 'c2g__inquirytemplatesignfilter__c', 'c2g__inquirytemplatesortitem__c', 'c2g__inquirytemplatetransposedrill__c', 'c2g__integrationrulessettings__c', 'c2g__intercompanysettings__c', 'c2g__massdeletebatchlog__c', 'c2g__massdeletecontrolrecord__c', 'c2g__objecttoobjectmap__c', 'c2g__objecttoobjectmapfieldlink__c', 'c2g__onlineinquiriespersonalsetting__c', 'c2g__palettesection__c', 'c2g__postinstallupgradesettings__c', 'c2g__rcppeer__c', 'c2g__relatedcontentpane__c', 'c2g__relatedcontentpanecomponent__c', 'c2g__relatedcontentpanetab__c', 'c2g__reportingbalance__c', 'c2g__summarizationlog__c', 'c2g__summarizationruninformation__c', 'c2g__summarizationtemplate__c', 'c2g__summarizationtemplatefieldprocess__c', 'c2g__taxdetailpayablecreditnote__c', 'c2g__taxdetailpayablecreditnoteexpense__c', 'c2g__taxdetailpayableinvoice__c', 'c2g__taxdetailpayableinvoiceexpense__c', 'c2g__taxdetailsalescreditnote__c', 'c2g__taxdetailsalesinvoice__c', 'c2g__transactionlog__c', 'c2g__transactionreconciliation__c', 'c2g__transactionreconciliationfilter__c', 'c2g__transactionreconciliationfilterstructure__c', 'c2g__transactionreconciliationlineitem__c', 'c2g__worker__c', 'c2g__workeritem__c', 'c2g__workerlog__c', 'c2g__workerloggroup__c', 'calc_building__c', 'calc_testing__c', 'calc_update__c', 'calculator_rate__c', 'calculator_update__c', 'call_merchant_notification__c', 'callcenter', 'campaign', 'campaignmember', 'campaignmemberstatus', 'case', 'casearticle', 'casecomment', 'casecontactrole', 'caseexternaldocument', 'casesolution', 'casestatus', 'casesubjectparticle', 'caseteammember', 'caseteamrole', 'caseteamtemplate', 'caseteamtemplatemember', 'caseteamtemplaterecord', 'cash_entry_bucket_s__c', 'cash_entry_wrapper__c', 'cashmatchingutilitiessettings__c', 'categorynode', 'categorynodelocalization', 'channelprogram', 'channelprogramlevel', 'channelprogrammember', 'chatter_group_access__c', 'chatteractivity', 'chatterconversation', 'chatterconversationmember', 'chatterextension', 'chatterextensionconfig', 'chatterextensionlocalization', 'chattermessage', 'clicked_link__c', 'clientbrowser', 'closer_cost__c', 'closer_performance_conversion_snapshot__c', 'closer_performance_submission_snapshot__c', 'closer_performance_transfers_snapshot__c', 'closer_quota__c', 'closer_speed_snapshot__c', 'clothing_apparel_snapshot__c', 'coa_statistics__c', 'coa_statistics_v2__c', 'coefficient__c', 'collaborationgroup', 'collaborationgroupmember', 'collaborationgroupmemberrequest', 'collaborationgrouprecord', 'collaborationinvitation', 'collection_issue_tracking__c', 'collection_issues_statistics__c', 'collection_schedule__c', 'collection_schedule_result__c', 'collections_cycle__c', 'collections_file__c', 'collections_issue__c', 'collections_likelihood__c', 'colordefinition', 'commission__c', 'community', 'connect_source_service__c', 'connectedapplication', 'contact', 'contactrequest', 'contentasset', 'contentbody', 'contentdistribution', 'contentdistributionview', 'contentdocument', 'contentdocumentlink', 'contentfolder', 'contentfolderitem', 'contentfoldermember', 'contenthubitem', 'contenthubrepository', 'contentnote', 'contentversion', 'continuous_variables__c', 'contract', 'contract__c', 'contract_block__c', 'contract_version_override__c', 'contractcontactrole', 'contractstatus', 'control_account_transaction_report__c', 'conversion_percent__c', 'corporate__c', 'cp_yodlee_bank_account__c', 'cron_trigger_ghost__c', 'cronjobdetail', 'crontrigger', 'cs_issues__c', 'css_test_customers__c', 'current_incompletes__c', 'custombrand', 'custombrandasset', 'customer__datacategoryselection', 'customer__ka', 'customer__kav', 'customer__viewstat', 'customer__votestat', 'customer_portal_activity__c', 'customer_portal_notification__c', 'customer_portal_popdown_configuration__c', 'customer_portal_popdown_notification__c', 'customer_service_issues__c', 'customhttpheader', 'customobjectuserlicensemetrics', 'custompermission', 'custompermissiondependency', 'daily__c', 'daily_incomplete_snapshot__c', 'daily_receipt_forecast_entry__c', 'daily_receipts_snapshot_2__c', 'daily_volume__c', 'dashboard', 'dashboard_receipts__c', 'dashboardcomponent', 'datacloudaddress', 'datacloudownedentity', 'datacloudpurchaseusage', 'dataintegrationrecordpurchasepermission', 'datasetexport', 'datasetexportevent', 'datasetexportpart', 'datastatistics', 'datatype', 'day_entries_max_hrs__c', 'day_entry__c', 'dc_share_percentage__c', 'ddcassess__assessment_summary__c', 'ddcassess__entity_assessment__c', 'ddcassess__field_assessment__c', 'ddcassess__matched_record__c', 'declinedeventrelation', 'deduplication_rule__c', 'defaultvalue__c', 'defaultvalues__c', 'detail_account_transaction_report__c', 'dfss_snapshot_item__c', 'dfss_snapshot_push__c', 'directmessage', 'directmessagemember', 'discount_call__c', 'discount_factor__c', 'discount_payout_snapshot__c', 'discountrate__c', 'document', 'documentattachmentmap', 'documents_required_for_pricing__c', 'docusign_documents_required_templates__c', 'docusign_drf_field_mapping__c', 'docusign_field_mapping__c', 'docusign_settings__c', 'docusignmailer__c', 'domain', 'domainsite', 'drf_docusign_templates__c', 'drf_mkt_funnel_snapshot__c', 'drf_mkt_funnel_this_month_snapshot__c', 'drf_snapshot__c', 'drf_wos_to_converted_by_closr_snap_shot__c', 'ds_remote_service_config__c', 'dsfs__docusign_envelope__c', 'dsfs__docusign_envelope_document__c', 'dsfs__docusign_envelope_recipient__c', 'dsfs__docusign_recipient_status__c', 'dsfs__docusign_status__c', 'dsfs__docusignaccountconfiguration__c', 'duplicate_leadtoaccount_buffer__c', 'duplicate_phone_buffer__c', 'duplicated_item__c', 'duplicatejob', 'duplicatejobdefinition', 'duplicatejobmatchingrule', 'duplicatejobmatchingruledefinition', 'duplicaterecorditem', 'duplicaterecordset', 'duplicaterule', 'ecommercemember__c', 'eft_file_number__c', 'email_alert__c', 'email_alert_tracking__c', 'email_template_access__c', 'email_template_tracking__c', 'emailmessage', 'emailmessagerelation', 'emailservicesaddress', 'emailservicesfunction', 'emailstatus', 'emailtemplate', 'embeddedservicedetail', 'employee_rating__c', 'entitydefinition', 'entityparticle', 'entitysubscription', 'equifaxquery__c', 'equifaxtrade__c', 'error_log__c', 'event', 'eventbussubscriber', 'eventlogfile', 'eventrelation', 'evo_payment__c', 'exchange_rate__c', 'expected_vs_actual_receipt__c', 'external_api_credential__c', 'externaldatasource', 'externaldatauserauth', 'externalsocialaccount', 'fairwarn__alert__c', 'fairwarn__alertticketassociation__c', 'fairwarn__investigation__c', 'fairwarn__involved_user__c', 'features__c', 'feedcomment', 'feeditem', 'feedlike', 'feedsignal', 'feedtrackedchange', 'ff_summary__c', 'ffbext__onetouchsettings__c', 'ffpayup__codatemporalpaymentlineitem__c', 'ffpayup__codaupgradeerror__c', 'field_reference__c', 'field_trip__field_analysis__c', 'field_trip__object_analysis__c', 'fielddefinition', 'fieldpermissions', 'file_log__c', 'file_storage__c', 'filesearchactivity', 'financial_institution__c', 'financial_sales_tool__c', 'fiscalyearsettings', 'fixed_cost_statistics__c', 'flag_as_corporate__c', 'flexqueueitem', 'flowinterview', 'flowstagerelation', 'folder', 'folderedcontentdocument', 'frictionless_score_mca_grad__c', 'frictionless_score_mca_reg__c', 'frictionless_score_monthly_snapshot__c', 'funding__c', 'funding_calculation_sheet__c', 'funding_forecast__c', 'funding_quarter_statistics__c', 'g_settings__c', 'galland_query_field__c', 'galland_score_statistics__c', 'generic_dsm_d_casl_1__c', 'generic_dsm_d_casl_2__c', 'gift_card__c', 'good_underwriting_days_snapshot__c', 'google_adwords_statistics__c', 'google_doc_mapping__c', 'graduated_advance_analyt__c', 'graduated_advance_speed_snapshot__c', 'grantedbylicense', 'group', 'groupmember', 'growthpayout__c', 'hair_and_beauty_snapshot__c', 'helpdesk__c', 'holiday', 'icalendar__icalendaroptions__c', 'icondefinition', 'icrt__guide_attributes_translation__c', 'icrt__guide_definition__c', 'icrt__guide_execution__c', 'icrt__guide_milestone__c', 'idea', 'ideacomment', 'ideassitesetup__c', 'impact_radius_notification__c', 'import__c', 'inbound_email__c', 'incomescheduleutilitiessettings__c', 'incomplete_responsible__c', 'incompletes_to_funding_ratio__c', 'individual', 'industry_areacode_statistics__c', 'industry_cluster_pd__c', 'industry_cluster_tc__c', 'industry_macro_data__c', 'industry_macro_data_value__c', 'inf_snapshot__c', 'informatica_endpoints__c', 'installedmobileapp', 'intercom99__intercomapisettings__c', 'internal_ip_address__c', 'interview__c', 'intuit_referral_reporting__c', 'issue__c', 'job_posting__c', 'journal_wrapper__c', 'key_collections_issues_over_20k_shapshot__c', 'key_collections_issues_snapshot__c', 'key_performance_indicator__c', 'knowledgeableuser', 'knowledgearticle', 'knowledgearticleversion', 'knowledgearticleviewstat', 'knowledgearticlevotestat', 'landlord_fee_structure__c', 'latest_created_opp_snapshot__c', 'lead', 'lead_assignment_industry_priority__c', 'lead_assignment_priority__c', 'lead_assignment_rule__c', 'lead_assignment_rule_user__c', 'lead_conversion_factor__c', 'lead_cost__c', 'lead_gen_quota__c', 'lead_source__c', 'leadactivitywrap__c', 'leadassignmentsettings__c', 'leadlinker__c', 'leadstatus', 'lessons_learned__c', 'lgd__c', 'lightningexperiencetheme', 'lightningtogglemetrics', 'lightningusagebyapptypemetrics', 'lightningusagebybrowsermetrics', 'lightningusagebyflexipagemetrics', 'lightningusagebypagemetrics', 'lineitemoverride', 'linkedarticle', 'listemail', 'listemailrecipientsource', 'listview', 'listviewchart', 'listviewchartinstance', 'loan_maturity_component__c', 'loan_multiplier__c', 'loans_contracts_in_and_out_snapshot__c', 'location__c', 'login_stage__c', 'login_to_portal_url__c', 'loginevent', 'logineventstream', 'loginip', 'logouteventstream', 'lookedupfromactivity', 'lstore__document_view__c', 'lstore__storage_settings__c', 'lstore__stored_document__c', 'macro', 'macroinstruction', 'mailmergetemplate', 'marketing_auto_fields__c', 'marketing_beauty__c', 'marketing_restaurant_fields__c', 'mass_email__c', 'mass_email_message__c', 'mass_email_recipient__c', 'mass_email_stats__c', 'matchingrule', 'matchingruleitem', 'maximum_available_discount_range__c', 'maximum_funding_model_output__c', 'mca_whp_rates__c', 'merchant_history__c', 'merchant_information_update__c', 'merchant_lead__c', 'merchant_milestone__c', 'mercy_requests__c', 'merge_pricings__c', 'merge_pricings_v2__c', 'milestone__c', 'missed_deposit_advance_size_comparison__c', 'monday_receipts_snapshot__c', 'moneris_monthly_volumes__c', 'monerismultilocationotification__c', 'monthly_approval_entry__c', 'monthly_volume_archive__c', 'myobj__c', 'name', 'namedcredential', 'namespaceregistry', 'navigationlinkset', 'navigationmenuitem', 'navigationmenuitemlocalization', 'network', 'networkaffinity', 'networkmember', 'networkmembergroup', 'networkpageoverride', 'networkselfregistration', 'new_dashboard_receipt__c', 'new_pricing_created__c', 'not_now_in_future_mkt_funnel_snapshot__c', 'note', 'notificationactivity__c', 'nsf_weekly_collection_snapshot__c', 'nsfs__c', 'nubik_salesvalue__c', 'oauthtoken', 'objectpermissions', 'off_balance_sheet_financing__c', 'one_penny__c', 'one_penny_cash_entry__c', 'open_cases__c', 'openactivity', 'opportunity_sales_note__c', 'opportunity_statistic__c', 'opportunitycompetitor', 'opportunitycontactrole', 'opportunitylineitem', 'opportunitylineitemschedule', 'opportunityoverride', 'opportunitypartner', 'opportunitystage', 'organization', 'orglifecyclenotification', 'orgwideemailaddress', 'outgoingemail', 'outgoingemailrelation', 'ownedcontentdocument', 'ownerchangeoptioninfo', 'packagelicense', 'parent__c', 'partner', 'partner_referral__c', 'partner_settings__c', 'partnerrole', 'partners__c', 'payment_schedule__c', 'paymentech_notification_emails__c', 'pd_output__c', 'pending_chatter__c', 'pending_mfmo_account__c', 'pending_wyman_opportunity__c', 'pendingworkentry__c', 'percent_of_max_advance_size__c', 'period', 'permissionset', 'permissionsetassignment', 'permissionsetlicense', 'permissionsetlicenseassign', 'phone_number_buffer__c', 'picklist_fields__c', 'picklist_options__c', 'picklistvalueinfo', 'pipeline_stage_by_rep__c', 'pipeline_trend__c', 'platformaction', 'platformcachepartition', 'platformcachepartitiontype', 'pmsp_snapshot__c', 'portal_application_activity__c', 'portal_logins_snapshot__c', 'portfolio_growth_snapshot__c', 'portfolio_size__c', 'portfolio_speed_snapshot_125k__c', 'portfolio_speed_snapshot_50k__c', 'portfolio_speed_snapshot__c', 'portfolio_speed_snapshot_high_risk_pric__c', 'portfolio_speed_snapshot_pmq__c', 'post_funding_call_new__c', 'post_may_2013_targets__c', 'potential_duplicated_lead__c', 'pre_underwriting_checklist__c', 'prepaid_credit_card_information__c', 'press__c', 'pricebook2', 'pricebookentry', 'pricing_category__c', 'pricing_details__c', 'pricing_document_type__c', 'pricing_documentation_required__c', 'pricing_documents_for_upload__c', 'pricing_oppen__c', 'pricing_option__c', 'pricing_product__c', 'pricing_product_product_category__c', 'pricing_rejection_criteria__c', 'pricing_snapshot__c', 'pricing_source__c', 'pricingsupplementary__c', 'priority_5_snapshot__c', 'priority_7_snapshot__c', 'priority_tracking__c', 'probability_of_default__c', 'processdefinition', 'processinstance', 'processinstancenode', 'processinstancestep', 'processinstanceworkitem', 'processnode', 'processor__c', 'product2', 'profile', 'profitability__c', 'project__c', 'project_charter__c', 'project_constraints__c', 'project_requirement__c', 'promo_code__c', 'promo_code_applied__c', 'proposal_mkt_funnel_snapshot__c', 'provisions_snapshot__c', 'publisher', 'push_funding_schedule__c', 'push_funding_schedule_account__c', 'push_funding_statistic__c', 'push_funding_summary__c', 'pushtopic', 'quality_assurance__c', 'quantityforecast', 'query_field__c', 'question', 'questiondatacategoryselection', 'queuesobject', 'quicktext', 'ratingimageurl__c', 'recentlyviewed', 'record_assignment__c', 'record_pool__c', 'recordaction', 'recordtype', 'recordtypelocalization', 'red_flag_tracking__c', 'referral_offer__c', 'region__c', 'relationship__c', 'relationshipdomain', 'relationshipinfo', 'repeat_eligible_projected_snapshot__c', 'repeat_sop_factor__c', 'repeat_target__c', 'reply', 'report', 'reported_error_object__c', 'reportevent', 'reporteventstream', 'reputationlevel', 'reputationlevellocalization', 'reputationpointsrule', 'request__c', 'requested_advance_size_by_rep__c', 'reseller_group__c', 'reserve_balance__c', 'reserved_lead_to_assign__c', 'restaurant_snapshot__c', 'revenueforecast', 'review__c', 'risk_model_output__c', 'risk_profit_class_snapshot__c', 'risk_score__c', 'roi_statistics__c', 'rypple_corp__badge__c', 'sales_budget_day__c', 'sales_budget_month__c', 'sales_metrics__c', 'sales_monthly_performance__c', 'sales_note__c', 'sales_tracking__c', 'sales_volume__c', 'samlssoconfig', 'scontrol', 'scontrollocalization', 'scoring_gap__c', 'scratchorginfo', 'searchactivity', 'searchlayout', 'searchpromotionrule', 'seasonality__c', 'secure_files__c', 'secure_notes__c', 'secureagentscluster', 'selfserviceuser', 'sessionpermsetactivation', 'setupaudittrail', 'setupentityaccess', 'sfdc_url__c', 'share_article__c', 'share_of_profit__c', 'site', 'site_visit__c', 'sitedetail', 'sitesnames__c', 'sobjecttransferbatchemails__c', 'socialpersona', 'socialpost', 'solution', 'solutionstatus', 'sop_bi_weekly__c', 'sop_calc__c', 'sop_multiples__c', 'sop_target__c', 'specified_amount_os__c', 'sprint_burn_down_snapshot__c', 'sql_updates__c', 'squaresettings__c', 'stage_time_entry__c', 'stamp', 'stampassignment', 'stamplocalization', 'statements_perfomance_entry__c', 'staticresource', 'streamingchannel', 'supplier_contract__c', 'survey__c', 'sync_queue__c', 'system_settings__c', 'tabdefinition', 'tagdefinition', 'task', 'taskpriority', 'taskstatus', 'tc_app_areacode__c', 'td_notification_emails__c', 'tech_services_statistics__c', 'tenantusageentitlement', 'testsuitemembership', 'thierno_test__c', 'thirdpartyaccountlink', 'time_in_business__c', 'time_in_collection_percent__c', 'todaygoal', 'top_up_component__c', 'top_up_snapshot__c', 'topic', 'topicassignment', 'topiclocalization', 'topupandsmallamountratios__c', 'total_funding__c', 'total_fundings_snapshot__c', 'total_portfolio_mca_loan__c', 'trac_emailnotificationconfig__c', 'trac_intuitconfig__c', 'trac_leadapplicationconfig__c', 'training_c__c', 'training_sessions__c', 'transaction_pool__c', 'transactionsecuritypolicy', 'transfer__c', 'transfer_assignment_buckets__c', 'transfer_to_conversions__c', 'transformation_parameters__c', 'undecidedeventrelation', 'unsubscribe_request__c', 'url_rewrite__c', 'url_rewriter_diff__c', 'user', 'user_management__c', 'user_permission__c', 'user_permission_values__c', 'user_user_permission__c', 'useraccountteammember', 'userappinfo', 'userappmenucustomization', 'userappmenuitem', 'usercustombadge', 'usercustombadgelocalization', 'userentityaccess', 'userfieldaccess', 'userlicense', 'userlistview', 'userlistviewcriterion', 'userlogin', 'userpackagelicense', 'userpermissionaccess', 'userpreference', 'userprovisioningrequest', 'userrecordaccess', 'userrole', 'utm_parameters__c', 'vaibtest__c', 'variability_statistics__c', 'visibilitychangenotification', 'volumes_weight_for_funding_benchmark__c', 'vote', 'w_wyman_settings__c', 'watch_item__c', 'waveautoinstallrequest', 'wavecompatibilitycheckitem', 'web_lead_source__c', 'website_generic__c', 'website_privacy_policy__c', 'weekly_bonus__c', 'weekly_status_report__c', 'welcome_call__c', 'welcome_letter_generation__c', 'win_percentage_factor__c', 'wip_entry__c', 'withdrawal__c', 'workaccess', 'workaround_cash_entry_lines__c', 'workbadge', 'workbadgedefinition', 'working_days__c', 'working_month__c', 'workthanks', 'writeoff__c', 'wyman_manual_inputs__c', 'x90_day_conversions_snapshot__c', 'yodlee_account__c', 'yodlee_merchants_snapshot__c', 'yodlee_status__c', 'zero_report_snapshot__c']

# wide_tables = [
#     {"name": "opportunity", "condition": None},
#     {"name": "pricing__c", "condition": None},
# ]


def ctas_to_glue(sobject: str):
    engine = create_engine(
        "presto://presto-production-internal.presto.svc:8080/sfni",
    )

    with engine.begin() as tx:
        tx.execute(f'''
        create table if not exists "glue"."sfni".{sobject} as select * from "sfni"."salesforce"."{sobject}"
        with no data
        ''').fetchall()

        try:
            max_date = tx.execute(f"select max(systemmodstamp) from glue.sfni.{sobject}").fetchall()[0][0]
            max_date = datetime.datetime.fromisoformat(max_date).__str__()
        except Exception:
            max_date = datetime.datetime.fromtimestamp(0).__str__()

        stmt = text(f'''
        insert into "glue"."sfni".{sobject} select * from "sfni"."salesforce"."{sobject}"
        where systemmodstamp > cast(:max_date as timestamp)
        ''').bindparams(max_date=max_date)

        tx.execute(stmt).fetchall()


with DAG(
        "sfni_to_glue_import",
        start_date=datetime.datetime(2019,10,9),
        schedule_interval=None
) as dag:
    for t in tables:
        dag << PythonOperator(
            task_id=t,
            python_callable=ctas_to_glue,
            op_kwargs={
                "sobject": t
            },
            pool="sfni_pool"
        )
